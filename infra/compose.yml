# Docker Compose for Thudbot Development
#
# This configuration is designed for local development with:
# - Local builds from source code for rapid iteration
# - Direct .env file usage (no Docker secrets needed)
# - Exposed Redis and Qdrant ports for debugging and inspection
# - Bridge networking for single-host development
# - Health checks and auto-restart for reliability
#
# NOTE:
# This compose file is for LOCAL DEVELOPMENT ONLY.
#
# It runs a full local stack:
#   backend → retrieval → qdrant → redis
#
# Production differs structurally:
#   - Retrieval + Qdrant run on a separate node (thudbot-retrieval)
#   - Backend talks to retrieval over HTTP
#   - App node uses Docker Swarm and secrets
#
# This file exists to:
#   - Enable fast local iteration
#   - Mirror the production call chain, not the production topology

#
# Usage:
# 1. Ensure .env file exists in project root with API keys
# 2. Run: docker compose up --build
# 3. Backend available at: http://localhost:8000
# 4. Retrieval API available at: http://localhost:8001
# 5. Redis available at: localhost:6379 (for debugging)
# 6. Qdrant available at: http://localhost:6333 (for debugging)
#
# Useful commands:
# - View logs: docker compose logs -f backend
# - Rebuild: docker compose up --build --force-recreate
# - Stop: docker compose down
#

services:
  redis:
    image: redis:7-alpine # Use the official Redis image
    container_name: thudbot-redis
    ports:
      - "6379:6379" # Expose Redis for debugging tools (redis-cli, GUI clients)
    command: redis-server

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

    networks:
      - thudbot-network # Use the bridge network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: thudbot-qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC (optional)
    volumes:
      - qdrant_storage:/qdrant/storage
    networks:
      - thudbot-network
    restart: unless-stopped


  retrieval:
    build:
      context: ..  # Repo root for access to rag_utils/
      dockerfile: apps/retrieval/Dockerfile
    container_name: thudbot-retrieval
    ports:
      - "8001:8001"  # Expose retrieval API
    environment:
      - QDRANT_URL=http://qdrant:6333  # Internal Docker network URL
      - QDRANT_COLLECTION=Thudbot_NarrativeHints_bge-base_20260106
      - EMBEDDING_PROVIDER=local
      - EMBEDDING_MODEL=BAAI/bge-base-en-v1.5
    env_file:
      - ../.env  # Local dev only; prod retrieval has no secrets
    depends_on:
      qdrant:
        condition: service_started
    networks:
      - thudbot-network
    restart: unless-stopped

  backend:
    build:  # Build the backend from source code
      context: ../apps/backend
      dockerfile: Dockerfile

    container_name: thudbot-backend

    ports:
      - "8000:8000"

    environment:
      - COMPOSE_MODE=true # Enables Docker service discovery for Redis connection
      - RETRIEVAL_API_URL=http://retrieval:8001  # Internal Docker network URL

    # volumes: # no longer needed with the new retrieval node
    #   - ../apps/backend/qdrant_db:/app/qdrant_db  # Bind mount local datastore (read-write for rebuilding)

    env_file:
      - ../.env # Load API keys from project root .env file
    depends_on: # Ensure Redis and Retrieval API are healthy before starting the backend
      redis:
        condition: service_healthy
      retrieval:
        condition: service_started

    healthcheck: # Ensure the backend is running properly
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    networks:
      - thudbot-network
    restart: unless-stopped # Auto-restart containers (simpler than Swarm deploy policies)

networks:
  thudbot-network:
    driver: bridge # Single-host networking for development

volumes:
  qdrant_storage:  # Named volume for persistent Qdrant storage (outside repo)
